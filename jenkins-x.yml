buildPack: none
pipelineConfig:
  pipelines:
    pullRequest:
      pipeline:
        agent:
            image: rawlingsj80/builder-go:wip30  # this WIP image is waiting for PR https://github.com/jenkins-x/jx/pull/5577 to merge.  base= 54595818e9c5015220880020a1111689d17926f1 with  cherry-picked 1453555b88cef1e4b11ad541aa93e364a3be082f 78e928da959357b4027148c1de107848c885bb7c a98cd6fc345f59c7d427cc6d78b1127be7c37c30  and 5b20ec6a02b78a50637bf94649b306321ae7a1d9
        environment:
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: admin_password
            name: ADMIN_PASSWORD
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: dashboard_auth_id
            name: DASHBOARD_AUTH_ID
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: dashboard_auth_secret
            name: DASHBOARD_AUTH_SECRET
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: domain_issuer_password
            name: DOMAIN_ISSUER_PASSWORD
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: domain_issuer_username
            name: DOMAIN_ISSUER_USERNAME
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: pipeline_github_user
            name: PIPELINE_GITHUB_USER
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: pipeline_github_token
            name: PIPELINE_GITHUB_TOKEN
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: pipeline_github_email
            name: PIPELINE_GITHUB_EMAIL
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: git_owner
            name: GIT_OWNER
          - valueFrom:
              secretKeyRef:
                name: arcalos-secret
                key: prow_hmac_token
            name: PROW_HMAC_TOKEN
          - value: jxaas
            name: USER
        stages:
        - name: create
          options:
            volumes:
              - name: sa
                secret:
                  secretName: arcalos-secret
                  items:
                    - key: ci_sa
                      path: sa/ci_bot.json
            containerOptions:
              volumeMounts:
                - mountPath: /secret
                  name: sa
          steps:
          - name: clone_arcalos
            command: git
            args:
            - clone
            - https://github.com/cloudbees/arcalos
          - name: create_project
            command: ./create_aps_consumer_project.sh
            args: ['${BRANCH_NAME}-${BUILD_NUMBER}arc']
            dir: arcalos
          - name: deploy
            command: ./deploy_aps.sh
            args: ['${BRANCH_NAME}-${BUILD_NUMBER}arc']
            dir: arcalos
#          - name: verify
#            command: ./verify.sh
    release:
      pipeline:
        agent:
          image: busybox
        stages:
        - name: release
          steps:
          - name: dummy
            command: echo
            args: ['TBD']
